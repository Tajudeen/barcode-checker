<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Member Validation</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; text-align: center; }
    #reader { width: 320px; margin: 0 auto; }
    .row { margin-top: 12px; }
    button { padding: 10px 16px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
    #memOut { font-weight: 700; }
    #status { margin-top: 10px; font-size: 1.1em; }
    .ok { color: green; } 
    .bad { color: #b00020; }
  </style>
</head>
<body>
  <h2>Scan QR Code</h2>

  <!-- QR scanner -->
  <div id="reader"></div>

  <!-- Show parsed data -->
  <div class="row">QR Text: <span id="raw">–</span></div>
  <div class="row">Membership No: <span id="memOut">–</span></div>

  <!-- Action buttons -->
  <div class="row">
    <button id="validateBtn" disabled>Check Payment</button>
    <button id="scanAgainBtn" disabled>Scan Again</button>
  </div>

  <!-- Status output -->
  <div id="status"></div>

  <script>
    // --- Parse QR text (comma separated) ---
    function parseQRCommaString(text) {
      const parts = text.split(",").map(s => s.trim()).filter(s => s.length > 0);
      if (parts.length < 4) {
        return { ok: false, reason: "QR does not have at least 4 items." };
      }

      const name = parts[0] ?? "";
      const category = parts[1] ?? "";
      const amount = parts[2] ?? "";
      const memNumberRaw = parts[3] ?? "";
      const memNumber = (memNumberRaw.match(/\d+/)?.[0]) ?? memNumberRaw;

      return { ok: true, name, category, amount, memNumber, email: parts[4] ?? "" };
    }

    // --- DOM elements ---
    const rawEl = document.getElementById("raw");
    const memOutEl = document.getElementById("memOut");
    const validateBtn = document.getElementById("validateBtn");
    const scanAgainBtn = document.getElementById("scanAgainBtn");
    const statusEl = document.getElementById("status");

    // --- Scanner setup ---
    const html5QrCode = new Html5Qrcode("reader");
    let lastParsed = null;
    let scanning = false;

    async function startScanner() {
      statusEl.textContent = "";
      rawEl.textContent = "–";
      memOutEl.textContent = "–";
      validateBtn.disabled = true;
      scanAgainBtn.disabled = true;
      lastParsed = null;

      if (scanning) return;
      scanning = true;

      await html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        () => {} // ignore scan errors
      );
    }

    async function stopScanner() {
      if (scanning) {
        await html5QrCode.stop();
        scanning = false;
      }
    }

    function onScanSuccess(decodedText) {
      rawEl.textContent = decodedText;

      const result = parseQRCommaString(decodedText);
      if (!result.ok) {
        memOutEl.textContent = "Invalid QR format";
        statusEl.textContent = result.reason;
        statusEl.className = "bad";
        return;
      }

      lastParsed = result;
      memOutEl.textContent = result.memNumber;

      validateBtn.disabled = false;
      scanAgainBtn.disabled = false;
      stopScanner();
    }

    // --- API call ---
    validateBtn.addEventListener("click", async () => {
      if (!lastParsed) return;

      statusEl.className = "";
      statusEl.textContent = "Checking payment...";

      try {
        const endpoint = `https://www.event.ananmembers.org/registrations/${lastParsed.memNumber}`;

        const resp = await fetch(endpoint, {
          method: "GET",
          headers: {
            "apikey": "123456", // your API key
            "Accept": "application/json"
            
          }
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`API ${resp.status}: ${text}`);
        }

        const data = await resp.json();
        console.log("API response:", data); // 👀 See full response in browser console

        if (data.paid === true || data.status === "paid") {
          statusEl.textContent = `✅ Member ${lastParsed.memNumber} has PAID`;
          statusEl.className = "ok";
        } else {
          statusEl.textContent = `❌ Member ${lastParsed.memNumber} has NOT paid`;
          statusEl.className = "bad";
        }
      } catch (err) {
        statusEl.textContent = `⚠️ API error: ${err.message}`;
        statusEl.className = "bad";
      }
    });

    scanAgainBtn.addEventListener("click", () => {
      startScanner();
    });

    startScanner();
  </script>
</body>
</html>


